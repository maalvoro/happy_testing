name: CI
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - run: npm test
      - run: npm run test:coverage
      - name: Publish Coverage Summary
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Percentage |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------------|" >> $GITHUB_STEP_SUMMARY
          node -e "
            try {
              const fs = require('fs');
              const data = JSON.parse(fs.readFileSync('coverage/coverage-final.json', 'utf8'));
              const total = data.total;
              console.log(\`| statements | \${total.statements.pct}% |\`);
              console.log(\`| branches | \${total.branches.pct}% |\`);
              console.log(\`| functions | \${total.functions.pct}% |\`);
              console.log(\`| lines | \${total.lines.pct}% |\`);
            } catch (e) {
              console.log('No coverage data found');
            }
          " >> $GITHUB_STEP_SUMMARY